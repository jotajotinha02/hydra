<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Vendas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: 500; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn:hover { opacity: 0.9; }
        .input { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%; }
        .grid { display: grid; gap: 16px; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .text-right { text-align: right; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; }
        .loading { opacity: 0.5; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container">
        <h1 class="text-3xl font-bold mb-6">Sistema de Contabilidade de Vendas</h1>
        
        <!-- Formulário -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4">Registrar Nova Venda</h2>
            <form id="saleForm" class="grid grid-3">
                <div>
                    <label class="block text-sm font-medium mb-1">Usuário:</label>
                    <input type="text" id="usuario" class="input" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Quantidade:</label>
                    <input type="number" id="quantidade" class="input" min="1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Valor (R$):</label>
                    <input type="number" id="valor" class="input" step="0.01" min="0.01" required>
                </div>
                <div class="col-span-3">
                    <button type="submit" class="btn btn-primary">Registrar Venda</button>
                </div>
            </form>
        </div>

        <!-- Filtros -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4">Filtros</h2>
            <div class="grid grid-3">
                <div>
                    <label class="block text-sm font-medium mb-1">Filtrar por usuário:</label>
                    <input type="text" id="filtroUsuario" class="input" placeholder="Digite o usuário">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Filtrar por data:</label>
                    <input type="date" id="filtroData" class="input">
                </div>
                <div class="flex items-end">
                    <button onclick="aplicarFiltros()" class="btn btn-primary mr-2">Filtrar</button>
                    <button onclick="limparFiltros()" class="btn btn-secondary">Limpar</button>
                </div>
            </div>
        </div>

        <!-- Totalizadores -->
        <div class="grid grid-3">
            <div class="card text-center">
                <h3 class="text-lg font-semibold">Total de Vendas</h3>
                <p id="totalVendas" class="text-2xl font-bold text-blue-600">0</p>
            </div>
            <div class="card text-center">
                <h3 class="text-lg font-semibold">Quantidade Total</h3>
                <p id="totalQuantidade" class="text-2xl font-bold text-green-600">0</p>
            </div>
            <div class="card text-center">
                <h3 class="text-lg font-semibold">Valor Total</h3>
                <p id="totalValor" class="text-2xl font-bold text-purple-600">R$ 0,00</p>
            </div>
        </div>

        <!-- Tabela de Vendas -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4">Histórico de Vendas</h2>
            <div id="loading" class="text-center py-4" style="display: none;">Carregando...</div>
            <div class="overflow-x-auto">
                <table id="salesTable">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Usuário</th>
                            <th>Quantidade</th>
                            <th>Valor</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="salesBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let allSales = [];

        // Carregar vendas
        async function loadSales(usuario = '', data = '') {
            try {
                document.getElementById('loading').style.display = 'block';
                
                let url = `${API_BASE}/sales`;
                const params = new URLSearchParams();
                if (usuario) params.append('usuario', usuario);
                if (data) params.append('data', data);
                if (params.toString()) url += '?' + params.toString();

                const response = await fetch(url);
                const sales = await response.json();
                
                allSales = sales;
                renderSales(sales);
                updateTotals(sales);
            } catch (error) {
                console.error('Erro ao carregar vendas:', error);
                alert('Erro ao carregar vendas. Verifique sua conexão.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Renderizar tabela
        function renderSales(sales) {
            const tbody = document.getElementById('salesBody');
            tbody.innerHTML = '';

            if (sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Nenhuma venda encontrada</td></tr>';
                return;
            }

            sales.forEach(sale => {
                const row = document.createElement('tr');
                const data = new Date(sale.data).toLocaleString('pt-BR');
                
                row.innerHTML = `
                    <td>${data}</td>
                    <td>${sale.usuario}</td>
                    <td>${sale.quantidade}</td>
                    <td>R$ ${parseFloat(sale.valor).toFixed(2).replace('.', ',')}</td>
                    <td>
                        <button onclick="deleteSale('${sale.id}')" class="btn btn-danger btn-sm">
                            Remover
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Atualizar totais
        function updateTotals(sales) {
            const totalVendas = sales.length;
            const totalQuantidade = sales.reduce((sum, sale) => sum + parseInt(sale.quantidade), 0);
            const totalValor = sales.reduce((sum, sale) => sum + parseFloat(sale.valor), 0);

            document.getElementById('totalVendas').textContent = totalVendas;
            document.getElementById('totalQuantidade').textContent = totalQuantidade;
            document.getElementById('totalValor').textContent = `R$ ${totalValor.toFixed(2).replace('.', ',')}`;
        }

        // Registrar venda
        document.getElementById('saleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const usuario = document.getElementById('usuario').value;
            const quantidade = document.getElementById('quantidade').value;
            const valor = document.getElementById('valor').value;

            try {
                const response = await fetch(`${API_BASE}/sales`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usuario,
                        quantidade: parseInt(quantidade),
                        valor: parseFloat(valor)
                    })
                });

                if (response.ok) {
                    document.getElementById('saleForm').reset();
                    await loadSales();
                    alert('Venda registrada com sucesso!');
                } else {
                    const error = await response.json();
                    alert('Erro ao registrar venda: ' + error.error);
                }
            } catch (error) {
                console.error('Erro ao registrar venda:', error);
                alert('Erro ao registrar venda. Verifique sua conexão.');
            }
        });

        // Deletar venda
        async function deleteSale(id) {
            if (!confirm('Tem certeza que deseja remover esta venda?')) return;

            try {
                const response = await fetch(`${API_BASE}/sales?id=${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadSales();
                    alert('Venda removida com sucesso!');
                } else {
                    const error = await response.json();
                    alert('Erro ao remover venda: ' + error.error);
                }
            } catch (error) {
                console.error('Erro ao remover venda:', error);
                alert('Erro ao remover venda. Verifique sua conexão.');
            }
        }

        // Aplicar filtros
        function aplicarFiltros() {
            const usuario = document.getElementById('filtroUsuario').value;
            const data = document.getElementById('filtroData').value;
            loadSales(usuario, data);
        }

        // Limpar filtros
        function limparFiltros() {
            document.getElementById('filtroUsuario').value = '';
            document.getElementById('filtroData').value = '';
            loadSales();
        }

        // Carregar vendas ao iniciar
        loadSales();
    </script>
</body>
</html>